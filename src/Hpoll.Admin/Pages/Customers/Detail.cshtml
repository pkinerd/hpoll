@page "{id:int}"
@model Hpoll.Admin.Pages.Customers.DetailModel
@{
    ViewData["Title"] = Model.Customer.Name;
}

<h1>@Model.Customer.Name</h1>

@if (!string.IsNullOrEmpty(Model.SuccessMessage))
{
    <div class="alert alert-success">@Model.SuccessMessage</div>
}

<div class="card">
    <dl>
        <dt>Status</dt><dd><span class="status status-@Model.Customer.Status">@Model.Customer.Status</span></dd>
        <dt>Timezone</dt><dd>@Model.Customer.TimeZoneId</dd>
        <dt>Email Send Times</dt>
        <dd>
            @if (!string.IsNullOrWhiteSpace(Model.Customer.SendTimesLocal))
            {
                @Model.Customer.SendTimesLocal <span style="color: #666;">(local time)</span>
            }
            else
            {
                <span style="color: #999;">Using default: @Model.DefaultSendTimesDisplay</span>
            }
        </dd>
        <dt>Next Email</dt>
        <dd>
            @if (Model.Customer.NextSendTimeUtc.HasValue)
            {
                @Model.Customer.NextSendTimeUtc.Value.ToString("yyyy-MM-dd HH:mm") <span style="color: #666;">UTC</span>
            }
            else
            {
                <span style="color: #999;">Not scheduled</span>
            }
        </dd>
        <dt>Created</dt><dd>@Model.Customer.CreatedAt.ToString("yyyy-MM-dd HH:mm") UTC</dd>
    </dl>
</div>

<div class="card" style="max-width: 500px;">
    <form method="post" asp-page-handler="UpdateName" asp-route-id="@Model.Customer.Id">
        <div class="form-group">
            <label asp-for="EditName">Name</label>
            <input asp-for="EditName" />
            <span asp-validation-for="EditName" style="color: #dc2626; font-size: 0.85rem;"></span>
        </div>
        <button type="submit" class="btn">Update Name</button>
    </form>
</div>

<div class="card" style="max-width: 500px;">
    <form method="post" asp-page-handler="UpdateEmails" asp-route-id="@Model.Customer.Id">
        <div class="form-group">
            <label asp-for="EditEmail">To</label>
            <input asp-for="EditEmail" placeholder="email1@example.com, email2@example.com" />
            <span style="font-size: 0.8rem; color: #666;">Comma-separated list of notification recipients</span>
            <span asp-validation-for="EditEmail" style="color: #dc2626; font-size: 0.85rem;"></span>
        </div>
        <div class="form-group">
            <label asp-for="EditCcEmails">CC</label>
            <input asp-for="EditCcEmails" placeholder="email1@example.com, email2@example.com" />
            <span style="font-size: 0.8rem; color: #666;">Comma-separated list of CC recipients</span>
        </div>
        <div class="form-group">
            <label asp-for="EditBccEmails">BCC</label>
            <input asp-for="EditBccEmails" placeholder="email1@example.com, email2@example.com" />
            <span style="font-size: 0.8rem; color: #666;">Comma-separated list of BCC recipients</span>
        </div>
        <button type="submit" class="btn">Update Emails</button>
    </form>
</div>

<div class="card" style="max-width: 500px;">
    <form method="post" asp-page-handler="UpdateSendTimes" asp-route-id="@Model.Customer.Id">
        <div class="form-group">
            <label asp-for="EditSendTimesLocal">Email Send Times (local time)</label>
            <input asp-for="EditSendTimesLocal" placeholder="19:30" />
            <span style="font-size: 0.8rem; color: #666;">Comma-separated times in HH:mm format (e.g., 07:00, 19:30). Leave empty to use default (@Model.DefaultSendTimesDisplay).</span>
            <span asp-validation-for="EditSendTimesLocal" style="color: #dc2626; font-size: 0.85rem;"></span>
        </div>
        <button type="submit" class="btn">Update Send Times</button>
    </form>
</div>

<div class="actions">
    <form method="post" asp-page-handler="ToggleStatus" asp-route-id="@Model.Customer.Id" style="display:inline;">
        @if (Model.Customer.Status == "active")
        {
            <button type="submit" class="btn btn-danger">Deactivate</button>
        }
        else
        {
            <button type="submit" class="btn btn-success">Reactivate</button>
        }
    </form>
    <form method="post" asp-page-handler="RegisterHub" asp-route-id="@Model.Customer.Id" style="display:inline;">
        <button type="submit" class="btn btn-primary">Register Hub</button>
    </form>
</div>

@if (!string.IsNullOrEmpty(Model.OAuthUrl))
{
    <div class="alert alert-success">
        <strong>Hue OAuth URL generated.</strong> Open this link to authorize a hub:<br />
        <a href="@Model.OAuthUrl" target="_blank" rel="noopener" style="word-break: break-all;">@Model.OAuthUrl</a>
    </div>
}

<h2>Hubs</h2>
@if (Model.Customer.Hubs.Any())
{
    <table>
        <thead><tr><th>Bridge ID</th><th>Status</th><th>Token Expires</th><th>Last Polled</th><th>Failures</th></tr></thead>
        <tbody>
        @foreach (var hub in Model.Customer.Hubs)
        {
            var remaining = hub.TokenExpiresAt - DateTime.UtcNow;
            var tokenClass = remaining.TotalHours > 48 ? "token-green" : remaining.TotalHours > 24 ? "token-yellow" : "token-red";
            <tr>
                <td><a asp-page="/Hubs/Detail" asp-route-id="@hub.Id">@hub.HueBridgeId</a></td>
                <td><span class="status status-@hub.Status">@hub.Status</span></td>
                <td class="@tokenClass">@hub.TokenExpiresAt.ToString("MM-dd HH:mm") (@($"{remaining.TotalHours:F0}h"))</td>
                <td>@(hub.LastPolledAt?.ToString("MM-dd HH:mm") ?? "Never")</td>
                <td>@hub.ConsecutiveFailures</td>
            </tr>
        }
        </tbody>
    </table>
}
else
{
    <p>No hubs registered. Use "Register Hub" to start the Hue OAuth flow.</p>
}

<h2>Activity Summary</h2>
@if (!Model.ShowActivitySummary)
{
    <a asp-page="/Customers/Detail" asp-route-id="@Model.Customer.Id" asp-route-activity="true" class="btn">Show Activity Summary</a>
}
else
{
    <a asp-page="/Customers/Detail" asp-route-id="@Model.Customer.Id" class="btn" style="margin-bottom: 1rem; display: inline-block;">Hide Activity Summary</a>

    @if (Model.ActivityWindows.Any())
    {
        <div class="card">
            <h3 style="font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; color: #666; margin-bottom: 0.5rem;">Motion Activity</h3>
            <table style="margin-bottom: 1rem;">
                <thead><tr><th>Window</th><th>Events</th><th>Active Sensors</th></tr></thead>
                <tbody>
                @foreach (var w in Model.ActivityWindows)
                {
                    var cappedEvents = Math.Min(w.TotalMotionEvents, 5);
                    var color = w.TotalMotionEvents == 0 ? "#e74c3c" : w.TotalMotionEvents == 1 ? "#f39c12" : "#27ae60";
                    var label = w.TotalMotionEvents >= 5 ? "5+" : w.TotalMotionEvents.ToString();
                    <tr>
                        <td>@w.Label</td>
                        <td><span style="color: @color; font-weight: 600;">@label</span></td>
                        <td>@w.DevicesWithMotion / @w.TotalMotionSensors</td>
                    </tr>
                }
                </tbody>
            </table>

            <h3 style="font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; color: #666; margin-bottom: 0.5rem;">Temperature Range (&deg;C)</h3>
            <table>
                <thead><tr><th>Window</th><th>Low</th><th>Median</th><th>High</th></tr></thead>
                <tbody>
                @foreach (var w in Model.ActivityWindows)
                {
                    <tr>
                        <td>@w.Label</td>
                        @if (w.TemperatureMin.HasValue)
                        {
                            <td style="color: #3498db;">@w.TemperatureMin.Value.ToString("F1")</td>
                            <td style="font-weight: bold;">@w.TemperatureMedian!.Value.ToString("F1")</td>
                            <td style="color: #e74c3c;">@w.TemperatureMax!.Value.ToString("F1")</td>
                        }
                        else
                        {
                            <td colspan="3" style="color: #999;">&mdash;</td>
                        }
                    </tr>
                }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <p>No activity data available for the current summary window.</p>
    }
}
